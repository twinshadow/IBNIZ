CC?=		gcc
EXE?=		ibniz
SRC=		vm_slow.c clipboard.c compiler.c
OBJ=		$(SRC:.c=.o)
PROG=		${EXE} vmtest ibniz2c
INTER=		font.i texts.i
PERL?=		perl
RM_F?=		rm -f
SDL_LDFLAGS:=	$(shell sdl-config --libs)
SDL_CFLAGS:=	$(shell sdl-config --cflags)
CFLAGS+=	-Wall ${SDL_CFLAGS}
LDFLAGS+=	-lm ${SDL_LDFLAGS}

ifdef DEBUG
CFLAGS+=	-g
OPTIMIZATION=	-O0
else
OPTIMIZATION=	-Os
endif

ifdef X11
CFLAGS+=	-DX11
LDFLAGS+=	-lX11
endif

all: ${EXE}

%.o: %.c
	${CC} -Werror ${CFLAGS} ${OPTIMIZATION} -c -o $@ $^

vm_slow.o: OPTIMIZATION= -O3

${PROG}:
	${CC} -Werror ${CFLAGS} ${OPTIMIZATION} ${LDFLAGS} -o $@ $^

ibniz: ui_sdl.o ${OBJ}
ibniz2c: CFLAGS+= -DIBNIZ2C
ibniz2c: ibniz2c.o compiler.o
vmtest: vm_test.o compiler.o vm_slow.o

font.i: font.pl
	${PERL} font.pl > font.i

runtest: vmtest
	./vmtest

clean:
	${RM_F} *.o *~ ibniz vmtest ibniz.exe whole.c

.PHONY: clean runtest
